<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kódkereső</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0078ff">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(()=>{console.log('SW reg failed')});
  }
</script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body {
    margin: 0;
    background-color: #fdfdfd;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    justify-content: space-between;
    align-items: center;
  }
  #reader {
    width: 100%;
    max-width: 400px;
    margin-top: 40px;
  }
  #result {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    font-weight: bold;
    color: #222;
    text-align: center;
  }
  #bottom {
    width: 100%;
    text-align: center;
    padding: 20px;
    background-color: #fff;
    border-top: 1px solid #ccc;
  }
  button {
    background-color: #0078ff;
    color: white;
    border: none;
    padding: 15px 25px;
    font-size: 1rem;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background-color: #005fcc;
  }
  input[type="file"] {
    margin-top: 10px;
  }
</style>
</head>
<body>
<input type="file" id="excelFile" accept=".xlsx, .xls" />
<div id="reader"></div>
<div id="result"></div>
<div id="bottom">
  <button id="restartBtn" disabled>Új vonalkód beolvasása</button>
</div>
<script>
let data = [];
let html5QrCode;

// Excel betöltése
document.getElementById('excelFile').addEventListener('change', (e) => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = (evt) => {
    const workbook = XLSX.read(evt.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    alert("Excel betöltve! Most már beolvashatsz vonalkódot.");
    startScanner();
  };
  reader.readAsBinaryString(file);
});

function findValueByCode(code) {
  for (let i = 0; i < data.length; i++) {  // i = 0, ha nincs fejléc
    if (String(data[i][0]) === String(code)) return data[i][1];
  }
  return "Nincs találat!";
}

function startScanner() {
  document.getElementById('result').textContent = "";
  document.getElementById('restartBtn').disabled = true;

  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode("reader");
  } else {
    html5QrCode.stop().then(()=>{}).catch(()=>{});
  }

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      html5QrCode.stop().then(() => {
        const value = findValueByCode(decodedText);
        document.getElementById("result").textContent = value;
        document.getElementById('restartBtn').disabled = false;
      }).catch(()=>{});
    }
  );
}

document.getElementById('restartBtn').addEventListener('click', () => {
  startScanner();
});
</script>
</body>
</html>